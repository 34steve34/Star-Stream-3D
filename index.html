<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Stream - v2.5.2</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: #0f0; }
        #ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; z-index: 10; }
        #zeroBtn { position: absolute; top: 10px; left: 10px; padding: 10px; background: #222; color: #0f0; border: 1px solid #0f0; z-index: 30; font-size: 10px; cursor: pointer; border-radius: 5px; }
        #version { position: absolute; top: 10px; right: 10px; color: rgba(255, 120, 0, 0.7); font-size: 10px; z-index: 30; }
        #thrustBtn { position: absolute; bottom: 20px; right: 20px; width: 104px; height: 104px; background: rgba(255, 120, 0, 0.3); color: white; border: 2px solid #ff7800; border-radius: 50%; cursor: pointer; font-size: 16px; z-index: 20; display: none; outline: none; }
        #thrustBtn.active { background: rgba(255, 120, 0, 0.7); }
        #hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; color: #0ff; font-size: 16px; display: none; width: 100%; pointer-events: none; }
        #timer { color: #ff00ff; font-weight: bold; font-size: 20px; }
        button#startBtn { padding: 15px 30px; font-size: 18px; background: #ff7800; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .indicator { position: absolute; width: 16px; height: 16px; background: radial-gradient(circle, #ff7800 0%, rgba(255,120,0,0) 80%); border-radius: 50%; pointer-events: none; z-index: 5; transform: translate(-50%, -50%); border: 1px solid rgba(255,120,0,0.2); }
        #scopeContainer { position: absolute; top: 50px; left: 20px; width: 160px; height: 160px; border: 3px solid #555; border-radius: 50%; overflow: hidden; display: none; background: #000; z-index: 40; box-shadow: 0 0 20px rgba(255,0,0,0.3); }
        #scopeRedDot { position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; background: #ff0000; border-radius: 50%; transform: translate(-50%, -50%); z-index: 45; box-shadow: 0 0 8px #ff0000; }
    </style>
</head>
<body>
    <div id="version">v2.5.2</div>
    <button id="zeroBtn">ZERO</button>
    <button id="thrustBtn">THRUST</button>
    <div id="scopeContainer"><div id="scopeRedDot"></div></div>
    <div id="hud">
        <div id="timer">02:00</div>
        <div>SCORE: <span id="score">0</span></div>
        <div>WAVE: <span id="wave">1</span> | TARGETS: <span id="targets">0</span></div>
    </div>
    <div id="ui"><button id="startBtn">START MISSION</button></div>
    <div id="indicator-container"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const CONFIG = {
            MAX_VELOCITY: 1.5, DRIFT_INERTIA: 0.95, ACCEL_FORCE: 0.08, BULLET_SPEED: 10,
            PITCH_SENSITIVITY: 0.03, YAW_SENSITIVITY: 0.024, EXPONENT: 1.6, DEADZONE: 1.2,
            SECTOR_SIZE: 3500, LOCAL_STAR_COUNT: 800, LOCAL_STAR_RANGE: 800,
            MISSION_TIME: 120, BASE_FOV: 75, SCOPE_FOV: 15, SCOPE_ACT_RAD: 0.25
        };

        let scene, camera, scopeCamera, renderer, ship;
        let starFields = [], localStars, targets = [], bullets = [];
        let isInitialized = false, isThrusting = false, gameActive = false;
        let phoneZero = { beta: 0, gamma: 0 }, rotVel = { p: 0, y: 0 }, velocity = new THREE.Vector3();
        let score = 0, wave = 1, timeLeft = CONFIG.MISSION_TIME;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(CONFIG.BASE_FOV, window.innerWidth/window.innerHeight, 1, 20000);
            scopeCamera = new THREE.PerspectiveCamera(CONFIG.SCOPE_FOV, 1, 1, 15000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.autoClear = false;
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(500, 1000, 500);
            scene.add(sun);

            // Scope light to ensure zoomed targets are visible
            const scopeLight = new THREE.PointLight(0xffffff, 1, 1000);
            scopeCamera.add(scopeLight);
            scene.add(scopeCamera);

            initStars();
            initLocalStars();
            spawnWave();
            animate();
            setInterval(() => { if(gameActive && timeLeft > 0) { timeLeft--; updateHUD(); }}, 1000);
        }

        function initStars() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(300 * 3);
            for(let i=0; i<300*3; i++) pos[i] = (Math.random()-0.5) * CONFIG.SECTOR_SIZE;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 3 });
            for(let x=-1; x<=1; x++) for(let z=-1; z<=1; z++) {
                const p = new THREE.Points(geo, mat);
                p.position.set(x*CONFIG.SECTOR_SIZE, 0, z*CONFIG.SECTOR_SIZE);
                scene.add(p); starFields.push(p);
            }
        }

        function initLocalStars() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(CONFIG.LOCAL_STAR_COUNT * 3);
            for(let i=0; i<CONFIG.LOCAL_STAR_COUNT*3; i++) pos[i] = (Math.random()-0.5)*CONFIG.LOCAL_STAR_RANGE;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            localStars = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xffffff, size: 1.2, transparent: true, opacity: 0.6 }));
            scene.add(localStars);
        }

        function updateIndicators() {
            const container = document.getElementById('indicator-container');
            container.innerHTML = '';
            if(!ship || !gameActive) return;

            const frustum = new THREE.Frustum();
            frustum.setFromProjectionMatrix(new THREE.Matrix4().multiplyMatrices(camera.projectionMatrix, camera.matrixWorldInverse));

            targets.forEach(t => {
                if (frustum.containsPoint(t.position)) return; // Don't show if visible

                const vector = t.position.clone().project(camera);
                const div = document.createElement('div');
                div.className = 'indicator';
                
                let x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                let y = (vector.y * -0.5 + 0.5) * window.innerHeight;

                if (vector.z > 1) { // Target is behind
                    x = window.innerWidth - x;
                    y = window.innerHeight - y;
                }

                x = Math.max(20, Math.min(window.innerWidth - 20, x));
                y = Math.max(20, Math.min(window.innerHeight - 20, y));

                div.style.left = `${x}px`;
                div.style.top = `${y}px`;
                container.appendChild(div);
            });
        }

        function handleScope() {
            if(!ship) return;
            const scopeUI = document.getElementById('scopeContainer');
            const shipDir = new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion).normalize();
            let inRange = false;

            targets.forEach(t => {
                const toT = new THREE.Vector3().subVectors(t.position, ship.position).normalize();
                if (shipDir.angleTo(toT) < CONFIG.SCOPE_ACT_RAD) inRange = true;
            });

            if (inRange) {
                scopeUI.style.display = 'block';
                scopeCamera.position.copy(ship.position);
                scopeCamera.quaternion.copy(ship.quaternion);
            } else {
                scopeUI.style.display = 'none';
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (ship && isInitialized && gameActive) {
                const camUp = new THREE.Vector3(0, 1, 0).applyQuaternion(camera.quaternion);
                const camRight = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
                ship.rotateOnWorldAxis(camUp, -rotVel.y);
                ship.rotateOnWorldAxis(camRight, -rotVel.p);

                if (isThrusting) {
                    const dir = new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion).normalize();
                    velocity.add(dir.multiplyScalar(CONFIG.ACCEL_FORCE));
                    if(velocity.length() > CONFIG.MAX_VELOCITY) velocity.setLength(CONFIG.MAX_VELOCITY);
                } else {
                    velocity.multiplyScalar(CONFIG.DRIFT_INERTIA);
                }
                ship.position.add(velocity);

                localStars.position.copy(ship.position);
                camera.position.lerp(ship.position.clone().add(new THREE.Vector3(0, 10, -40).applyQuaternion(ship.quaternion)), 0.1);
                camera.lookAt(ship.position);

                updateIndicators();
                handleScope();
            }

            bullets.forEach((b, i) => {
                b.position.add(b.userData.vel);
                targets.forEach((t, ti) => {
                    if (b.position.distanceTo(t.position) < 30) {
                        scene.remove(t); targets.splice(ti, 1);
                        scene.remove(b); bullets.splice(i, 1);
                        score += 10; updateHUD();
                        if(targets.length === 0) spawnWave();
                    }
                });
                if(Date.now() - b.userData.time > 4000) { scene.remove(b); bullets.splice(i, 1); }
            });

            renderer.clear();
            renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
            renderer.render(scene, camera);

            if (document.getElementById('scopeContainer').style.display === 'block') {
                renderer.setScissorTest(true);
                renderer.setScissor(20, window.innerHeight - 210, 160, 160);
                renderer.setViewport(20, window.innerHeight - 210, 160, 160);
                renderer.render(scene, scopeCamera);
                renderer.setScissorTest(false);
            }
        }

        function fire() {
            const b = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshBasicMaterial({ color: 0xff00ff }));
            b.position.copy(ship.position);
            b.userData = { vel: new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion).multiplyScalar(CONFIG.BULLET_SPEED), time: Date.now() };
            scene.add(b); bullets.push(b);
        }

        function spawnWave() {
            for (let i = 0; i < 8 + wave * 2; i++) {
                const t = new THREE.Mesh(new THREE.IcosahedronGeometry(15), new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x003333 }));
                t.position.set((Math.random()-0.5)*2000, (Math.random()-0.5)*1000, (Math.random()-0.5)*2000);
                scene.add(t); targets.push(t);
            }
            wave++; updateHUD();
        }

        function updateHUD() {
            document.getElementById('score').textContent = score;
            document.getElementById('wave').textContent = wave;
            document.getElementById('targets').textContent = targets.length;
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('timer').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            this.style.display = 'none'; document.getElementById('hud').style.display = 'block'; document.getElementById('thrustBtn').style.display = 'block';
            gameActive = true; init();
            new GLTFLoader().load('./assets/ship.glb', (g) => { ship = g.scene; scene.add(ship); ship.scale.setScalar(3); }, undefined, () => {
                ship = new THREE.Mesh(new THREE.BoxGeometry(4, 2, 8), new THREE.MeshStandardMaterial({ color: 0x888888 }));
                scene.add(ship);
            });
            window.addEventListener('deviceorientation', (e) => {
                if(!isInitialized) { phoneZero = { b: e.beta, g: e.gamma }; isInitialized = true; }
                const curve = (v) => Math.abs(v) < CONFIG.DEADZONE ? 0 : Math.sign(v) * Math.pow(Math.abs(v)/35, CONFIG.EXPONENT);
                rotVel.p = curve(e.gamma - phoneZero.g) * CONFIG.PITCH_SENSITIVITY;
                rotVel.y = curve(e.beta - phoneZero.b) * CONFIG.YAW_SENSITIVITY;
            });
            window.addEventListener('touchstart', (e) => { if(e.target.id !== 'thrustBtn') fire(); });
            const btn = document.getElementById('thrustBtn');
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); isThrusting = true; btn.classList.add('active'); });
            btn.addEventListener('touchend', (e) => { isThrusting = false; btn.classList.remove('active'); });
        });
    </script>
</body>
</html>