<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Stream - v2.5.3</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: #0f0; }
        #ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; z-index: 10; }
        #resetBtn { position: absolute; top: 10px; left: 10px; padding: 10px; background: #a00; color: white; border: 1px solid #fff; z-index: 30; font-size: 10px; cursor: pointer; border-radius: 5px; }
        #version { position: absolute; top: 10px; right: 10px; color: rgba(255, 120, 0, 0.7); font-size: 10px; z-index: 30; }
        #thrustBtn { position: absolute; bottom: 20px; right: 20px; width: 110px; height: 110px; background: rgba(255, 120, 0, 0.3); color: white; border: 3px solid #ff7800; border-radius: 50%; cursor: pointer; font-size: 16px; z-index: 20; display: none; outline: none; }
        #thrustBtn.active { background: rgba(255, 120, 0, 0.7); }
        #hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; color: #0ff; font-size: 16px; display: none; width: 100%; pointer-events: none; }
        button#startBtn { padding: 15px 30px; font-size: 18px; background: #ff7800; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .indicator { position: absolute; width: 18px; height: 18px; background: radial-gradient(circle, #ff7800 0%, rgba(255,120,0,0) 80%); border-radius: 50%; pointer-events: none; z-index: 5; transform: translate(-50%, -50%); border: 1px solid rgba(255,120,0,0.4); }
        #scopeContainer { position: absolute; top: 40px; left: 20px; width: 170px; height: 170px; border: 4px solid #333; border-radius: 50%; overflow: hidden; display: none; background: #010101; z-index: 40; }
        #scopeRedDot { position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; background: #f00; border-radius: 50%; transform: translate(-50%, -50%); z-index: 45; box-shadow: 0 0 10px #f00; }
    </style>
</head>
<body>
    <div id="version">v2.5.3</div>
    <button id="resetBtn">NEW SESSION</button>
    <button id="thrustBtn">THRUST</button>
    <div id="scopeContainer"><div id="scopeRedDot"></div></div>
    <div id="hud">
        <div id="timer">02:00</div>
        <div>SCORE: <span id="score">0</span> | WAVE: <span id="wave">1</span></div>
        <div>TARGETS: <span id="targets">0</span></div>
    </div>
    <div id="ui"><button id="startBtn">START MISSION</button></div>
    <div id="indicator-container"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const CONFIG = {
            MAX_VELOCITY: 1.8, DRIFT: 0.96, ACCEL: 0.1, BULLET_SPD: 12,
            PITCH_SENS: 0.04, YAW_SENS: 0.03, DEADZONE: 1.5,
            SECTOR: 4000, MISSION_TIME: 120, SCOPE_FOV: 12, SCOPE_DIST: 600
        };

        let scene, camera, scopeCamera, renderer, ship;
        let starFields = [], targets = [], bullets = [];
        let isInit = false, isThrust = false, gameActive = false;
        let phoneZero = { b: 0, g: 0 }, velocity = new THREE.Vector3();
        let score = 0, wave = 1, timeLeft = CONFIG.MISSION_TIME;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 25000);
            scopeCamera = new THREE.PerspectiveCamera(CONFIG.SCOPE_FOV, 1, 1, 15000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.autoClear = false;
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(1000, 1000, 1000);
            scene.add(sun);

            createStars();
            spawnWave();
            animate();
            setInterval(() => { if(gameActive && timeLeft > 0) { timeLeft--; updateHUD(); }}, 1000);
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(500 * 3);
            for(let i=0; i<500*3; i++) pos[i] = (Math.random()-0.5) * CONFIG.SECTOR;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 2 });
            for(let x=-1; x<=1; x++) {
                for(let z=-1; z<=1; z++) {
                    const p = new THREE.Points(geo, mat);
                    p.position.set(x*CONFIG.SECTOR, 0, z*CONFIG.SECTOR);
                    scene.add(p); starFields.push(p);
                }
            }
        }

        function updateIndicators() {
            const container = document.getElementById('indicator-container');
            container.innerHTML = '';
            if(!ship || !gameActive) return;

            const frustum = new THREE.Frustum();
            frustum.setFromProjectionMatrix(new THREE.Matrix4().multiplyMatrices(camera.projectionMatrix, camera.matrixWorldInverse));

            targets.forEach(t => {
                const vector = t.position.clone().project(camera);
                // Hide if in the center of the screen
                if (frustum.containsPoint(t.position) && Math.abs(vector.x) < 0.8 && Math.abs(vector.y) < 0.8) return;

                const div = document.createElement('div');
                div.className = 'indicator';
                let x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                let y = (vector.y * -0.5 + 0.5) * window.innerHeight;

                if (vector.z > 1) { x = window.innerWidth - x; y = window.innerHeight - y; }

                x = Math.max(25, Math.min(window.innerWidth - 25, x));
                y = Math.max(25, Math.min(window.innerHeight - 25, y));

                div.style.left = `${x}px`;
                div.style.top = `${y}px`;
                container.appendChild(div);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if (ship && isInit && gameActive) {
                // Directional Logic
                const shipForward = new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion);
                
                if (isThrust) {
                    velocity.add(shipForward.clone().multiplyScalar(CONFIG.ACCEL));
                    if(velocity.length() > CONFIG.MAX_VELOCITY) velocity.setLength(CONFIG.MAX_VELOCITY);
                } else {
                    velocity.multiplyScalar(CONFIG.DRIFT);
                }
                ship.position.add(velocity);

                // Smooth Camera Follow
                const idealPos = ship.position.clone().add(shipForward.clone().multiplyScalar(-50)).add(new THREE.Vector3(0, 12, 0));
                camera.position.lerp(idealPos, 0.1);
                camera.lookAt(ship.position.clone().add(shipForward.clone().multiplyScalar(100)));

                // Scope Sync
                scopeCamera.position.copy(ship.position);
                scopeCamera.quaternion.copy(ship.quaternion);
                
                handleScopeUI(shipForward);
                updateIndicators();
            }

            bullets.forEach((b, i) => {
                b.position.add(b.userData.vel);
                targets.forEach((t, ti) => {
                    if (b.position.distanceTo(t.position) < 40) {
                        scene.remove(t); targets.splice(ti, 1);
                        scene.remove(b); bullets.splice(i, 1);
                        score += 50; updateHUD();
                        if(targets.length === 0) { wave++; spawnWave(); }
                    }
                });
                if(Date.now() - b.userData.time > 3000) { scene.remove(b); bullets.splice(i, 1); }
            });

            renderer.clear();
            renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
            renderer.render(scene, camera);

            if (document.getElementById('scopeContainer').style.display === 'block') {
                renderer.setScissorTest(true);
                renderer.setScissor(20, window.innerHeight - 210, 170, 170);
                renderer.setViewport(20, window.innerHeight - 210, 170, 170);
                renderer.render(scene, scopeCamera);
                renderer.setScissorTest(false);
            }
        }

        function handleScopeUI(forward) {
            let spotted = false;
            targets.forEach(t => {
                const toT = new THREE.Vector3().subVectors(t.position, ship.position).normalize();
                if (forward.angleTo(toT) < 0.2) spotted = true;
            });
            document.getElementById('scopeContainer').style.display = spotted ? 'block' : 'none';
        }

        function fire() {
            const b = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshBasicMaterial({ color: 0xff00ff }));
            b.position.copy(ship.position);
            const dir = new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion);
            b.userData = { vel: dir.multiplyScalar(CONFIG.BULLET_SPD), time: Date.now() };
            scene.add(b); bullets.push(b);
        }

        function spawnWave() {
            for (let i = 0; i < 10; i++) {
                const t = new THREE.Mesh(new THREE.IcosahedronGeometry(20), new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x002222 }));
                t.position.set((Math.random()-0.5)*3000, (Math.random()-0.5)*1000, (Math.random()-0.5)*3000);
                scene.add(t); targets.push(t);
            }
        }

        function updateHUD() {
            document.getElementById('score').textContent = score;
            document.getElementById('wave').textContent = wave;
            document.getElementById('targets').textContent = targets.length;
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('timer').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            this.style.display = 'none'; 
            document.getElementById('hud').style.display = 'block'; 
            document.getElementById('thrustBtn').style.display = 'block';
            gameActive = true; init();
            new GLTFLoader().load('./assets/ship.glb', (g) => { 
                ship = g.scene; scene.add(ship); ship.scale.setScalar(4); 
            }, undefined, () => {
                ship = new THREE.Mesh(new THREE.BoxGeometry(5, 2, 10), new THREE.MeshStandardMaterial({ color: 0x555555 }));
                scene.add(ship);
            });

            window.addEventListener('deviceorientation', (e) => {
                if(!isInit) { phoneZero = { b: e.beta, g: e.gamma }; isInit = true; }
                const bDiff = (e.beta - phoneZero.b);
                const gDiff = (e.gamma - phoneZero.g);
                if(Math.abs(bDiff) > CONFIG.DEADZONE) ship.rotateY(-bDiff * 0.001 * CONFIG.YAW_SENS);
                if(Math.abs(gDiff) > CONFIG.DEADZONE) ship.rotateX(gDiff * 0.001 * CONFIG.PITCH_SENS);
            });

            window.addEventListener('touchstart', (e) => { if(e.target.id !== 'thrustBtn' && e.target.id !== 'resetBtn') fire(); });
            const tb = document.getElementById('thrustBtn');
            tb.addEventListener('touchstart', (e) => { e.preventDefault(); isThrust = true; tb.classList.add('active'); });
            tb.addEventListener('touchend', (e) => { isThrust = false; tb.classList.remove('active'); });
        });

        document.getElementById('resetBtn').addEventListener('click', () => location.reload());
    </script>
</body>
</html>