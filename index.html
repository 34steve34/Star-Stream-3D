<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Star Stream - Bloom Test V13</title>

<style>
    body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: #0f0; }
    #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    #ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; z-index: 10; }
    #zeroBtn { position: absolute; top: 10px; left: 10px; padding: 10px; background: #222; color: #0f0; border: 1px solid #0f0; z-index: 20; font-size: 12px; cursor: pointer; }
    button { padding: 15px 30px; font-size: 18px; background: #ff7800; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #debug { position: absolute; top: 50px; left: 10px; font-size: 11px; pointer-events: none; color: #fff; line-height: 1.4; }
    #versionBadge { position: absolute; top: 10px; right: 10px; background: rgba(0, 255, 0, 0.2); padding: 5px; border: 1px solid #0f0; font-size: 12px; color: #0f0; }
</style>
</head>

<body>
<canvas id="overlay"></canvas>

<div id="ui">
    <button id="startBtn">ENGAGE TEST</button>
</div>

<div id="zeroBtn">ZERO</div>
<div id="debug">System Ready</div>
<div id="versionBadge">VER: BLOOM-V13</div>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

let scene, camera, renderer, ship, shipLight;
let threats = [];
let bullets = [];
let phoneZero = { beta: 0, gamma: 0 };
let currentVelocity = { p: 0, y: 0 };
let isInitialized = false;
let testAngle = 0;

const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const debug = document.getElementById('debug');

function init() {
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
    camera.position.set(0, 5, 25);
    camera.lookAt(0, 0, 0);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.3));

    const sun = new THREE.DirectionalLight(0xffffff, 2.5);
    sun.position.set(10, 20, 10);
    scene.add(sun);

    shipLight = new THREE.PointLight(0x00ffff, 150, 100);
    scene.add(shipLight);

    // Stars
    const vertices = [];
    for (let i = 0; i < 3000; i++) {
        vertices.push(
            THREE.MathUtils.randFloatSpread(2000),
            THREE.MathUtils.randFloatSpread(2000),
            THREE.MathUtils.randFloatSpread(2000)
        );
    }
    const starGeo = new THREE.BufferGeometry();
    starGeo.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
    scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 2 })));

    spawnThreat(0, 5, 100);

    window.addEventListener('resize', onWindowResize);
    window.addEventListener('touchstart', fireLaser);

    animate();
}

function spawnThreat(x, y, z) {
    const mesh = new THREE.Mesh(
        new THREE.SphereGeometry(8, 32, 32),
        new THREE.MeshStandardMaterial({
            color: 0xff0000,
            emissive: 0x440000,
            emissiveIntensity: 0.5
        })
    );
    mesh.position.set(x, y, z);
    scene.add(mesh);
    threats.push(mesh);
}

function fireLaser() {
    if (!ship) return;

    // ðŸ”¹ Laser bolt geometry (clean, readable)
    const bGeo = new THREE.CylinderGeometry(0.25, 0.25, 4, 8);
    bGeo.rotateX(Math.PI / 2);

    const bMat = new THREE.MeshStandardMaterial({
        color: 0x00ffff,
        emissive: 0x00ffff,
        emissiveIntensity: 2
    });

    const b = new THREE.Mesh(bGeo, bMat);

    // Ship forward direction (+Z after rotation)
    const dir = new THREE.Vector3(0, 0, 1)
        .applyQuaternion(ship.quaternion)
        .normalize();

    // ðŸ”¹ Spawn at ship nose (offset forward)
    const muzzleOffset = 8;
    b.position.copy(ship.position).add(dir.clone().multiplyScalar(muzzleOffset));

    // ðŸ”¹ Slower, readable speed
    b.userData.velocity = dir.multiplyScalar(10);
    b.userData.trail = [b.position.clone(), b.position.clone()];

    scene.add(b);
    bullets.push(b);
}

function animate() {
    requestAnimationFrame(animate);

    if (threats.length > 0) {
        testAngle += 0.01;
        threats[0].position.x = Math.sin(testAngle) * 60;
        threats[0].position.y = 5 + Math.cos(testAngle) * 30;
        threats[0].position.z = 100 + Math.sin(testAngle * 0.5) * 30;
    }

    if (ship && isInitialized) {
        ship.rotateOnWorldAxis(new THREE.Vector3(1, 0, 0), -currentVelocity.p);
        ship.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), -currentVelocity.y);
        shipLight.position.copy(ship.position).add(new THREE.Vector3(0, 5, 10));
    }

    bullets.forEach((b, i) => {
        b.position.add(b.userData.velocity);

        if (b.position.length() > 2000) {
            scene.remove(b);
            bullets.splice(i, 1);
        }
    });

    renderer.render(scene, camera);
}

function onDeviceMove(e) {
    if (!isInitialized) return;
    let pDiff = e.gamma - phoneZero.gamma;
    let yDiff = e.beta - phoneZero.beta;
    currentVelocity.p = Math.abs(pDiff) > 3 ? pDiff * 0.001 : 0;
    currentVelocity.y = Math.abs(yDiff) > 3 ? yDiff * -0.001 : 0;
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    overlay.width = window.innerWidth;
    overlay.height = window.innerHeight;
}

document.getElementById('zeroBtn').addEventListener('touchstart', e => {
    e.preventDefault();
    isInitialized = false;
    debug.innerText = "RE-ZEROING...";
});

document.getElementById('startBtn').addEventListener('click', function () {
    this.style.display = 'none';
    init();
    onWindowResize();

    new GLTFLoader().load('./assets/ship.glb', gltf => {
        ship = gltf.scene;
        ship.traverse(n => { if (n.isMesh) n.material.flatShading = false; });
        ship.position.set(0, 0, 0);
        ship.rotation.set(
            THREE.MathUtils.degToRad(-20),
            THREE.MathUtils.degToRad(180),
            0
        );
        scene.add(ship);
    });

    window.addEventListener('deviceorientation', e => {
        if (!isInitialized) {
            phoneZero = { beta: e.beta, gamma: e.gamma };
            isInitialized = true;
            debug.innerText = "TEST ACTIVE";
        }
        onDeviceMove(e);
    });
});
</script>
</body>
</html>
