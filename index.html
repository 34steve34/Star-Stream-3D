<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Stream 3D - v4.7.1</title>
	<link rel="manifest" href="manifest.json">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: #0f0; touch-action: none; }
        #ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; z-index: 10; display: flex; flex-direction: column; align-items: center; gap: 15px; }
		#zeroBtn { position: absolute; top: 10px; left: 10px; padding: 10px; background: #222; color: #0f0; border: 1px solid #0f0; z-index: 30; font-size: 10px; cursor: pointer; border-radius: 5px; }
        #version { position: absolute; top: 10px; right: 10px; color: rgba(255, 120, 0, 0.7); font-size: 10px; z-index: 30; }
        #thrustBtn { position: absolute; bottom: 20px; right: 20px; width: 104px; height: 104px; background: rgba(255, 120, 0, 0.3); color: white; border: 2px solid #ff7800; border-radius: 50%; cursor: pointer; font-size: 14px; z-index: 20; display: none; -webkit-user-select: none; }
        #thrustBtn.active { background: rgba(255, 120, 0, 0.7); }
        #hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; color: #0ff; font-size: 16px; display: none; width: 100%; pointer-events: none; }
        #timer { color: #ff00ff; font-weight: bold; font-size: 20px; }
        #scopeCanvas { position: absolute; top: 50px; right: 20px; width: 220px; height: 220px; border: 3px solid rgba(255, 0, 0, 0.8); border-radius: 50%; z-index: 15; display: none; box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); background: #000; }
        #scopeCrosshair { position: absolute; top: 50px; right: 20px; width: 220px; height: 220px; z-index: 17; display: none; pointer-events: none; }
        #scopeReticle { position: absolute; bottom: 130px; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: radial-gradient(circle, #ff0000 0%, rgba(255, 0, 0, 0.8) 50%, rgba(255, 0, 0, 0) 100%); border-radius: 50%; z-index: 16; display: none; box-shadow: 0 0 8px #ff0000; }
        #pointPop { position: absolute; top: 150px; right: 280px; color: #ffaa00; font-size: 28px; font-weight: bold; text-shadow: 0 0 15px #ffaa00; opacity: 0; z-index: 50; pointer-events: none; transition: opacity 0.2s ease-out; }
        .indicator { position: absolute; border-radius: 50%; pointer-events: none; z-index: 5; transform: translate(-50%, -50%); }
        #results { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; background: rgba(0,0,0,0.95); padding: 20px 30px; border: 2px solid #00E676; z-index: 110; box-shadow: 0 0 30px rgba(0,230,118,0.3); width: 85%; max-width: 600px; border-radius: 10px; }
        #results h1 { color: #fff; font-size: 24px; margin: 0 0 15px 0; letter-spacing: 2px; }
        .current-stats-container { display: flex; justify-content: space-around; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        .stat-box { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 14px; letter-spacing: 2px; margin-bottom: 5px; }
        .stat-value { font-size: 48px; font-weight: bold; line-height: 1; }
        .score-green { color: #00E676; text-shadow: 0 0 15px rgba(0,230,118,0.5); }
        .score-orange { color: #ffaa00; text-shadow: 0 0 15px rgba(255,170,0,0.5); }
        .leaderboards-container { display: flex; justify-content: space-between; gap: 30px; margin-bottom: 15px; }
        .leaderboard-col { flex: 1; }
        .score-section-title { font-size: 16px; font-weight: bold; color: #fff; text-align: center; border-bottom: 2px solid #00E676; padding-bottom: 5px; margin-bottom: 10px; }
        .score-list { text-align: left; color: #fff; font-size: 16px; }
        .score-row { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(0, 230, 118, 0.4); padding: 6px 0; }
        #startBtn { padding: 15px 30px; font-size: 18px; background: #00E676; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 280px; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }
        #replayBtn { padding: 12px 20px; font-size: 18px; cursor: pointer; background: #00E676; color: #000; border: none; border-radius: 5px; font-weight: bold; width: 100%; text-transform: uppercase; }
    </style>
</head>
<body>
    <div id="version">v4.7.1</div>
    <button id="zeroBtn">ZERO</button>
    <button id="thrustBtn">THRUST</button>
    <div id="hud">
        <div id="timer">03:00</div>
        <div>SCORE: <span id="score">0</span></div>
        <div>WAVE: <span id="wave">1</span> | TARGETS: <span id="targets">0</span></div>
    </div>
    <div id="ui">
        <button id="startBtn">START MISSION</button>
    </div>
    <div id="indicator-container"></div>
    <canvas id="scopeCanvas"></canvas>
    <canvas id="scopeCrosshair" width="220" height="220"></canvas>
    <div id="scopeReticle"></div>
    <div id="pointPop">+0</div>
    <div id="results">
        <h1>MISSION COMPLETE</h1>
        <div class="current-stats-container">
            <div class="stat-box">
                <div class="stat-label score-green">YOUR SCORE</div>
                <div class="stat-value score-green" id="finalScore">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label score-orange">BEST SHOT</div>
                <div class="stat-value score-orange" id="currentBestShotUI">0</div>
            </div>
        </div>
        <div class="leaderboards-container">
            <div class="leaderboard-col">
                <div class="score-section-title">TOP 4 TOTAL SCORES</div>
                <div class="score-list" id="totalLeaderboard"></div>
            </div>
            <div class="leaderboard-col">
                <div class="score-section-title">TOP 4 BEST SHOTS</div>
                <div class="score-list" id="shotsLeaderboard"></div>
            </div>
        </div>
        <button id="replayBtn">PLAY AGAIN</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';

        const CONFIG = {
            MAX_VELOCITY: 1.5, DRIFT_INERTIA: 0.95, ACCEL_FORCE: 0.08, BULLET_SPEED: 9,
            PITCH_SENSITIVITY: 0.035, YAW_SENSITIVITY: 0.03, EXPONENT: 1.6, DEADZONE: 1.2,
            SECTOR_SIZE: 3500, LOCAL_STAR_COUNT: 800, LOCAL_STAR_RANGE: 800,
            CAMERA_RADIUS: 80, MISSION_TIME: 180, BASE_FOV: 75, MAX_FOV_BOOST: 18,
            FOV_SMOOTHING: 0.03, SCOPE_RANGE: 2000, SCOPE_FOV: 30, SCOPE_FORWARD_OFFSET: 8,
            SCOPE_HIT_DISTANCE: 150, EXPLOSION_SHARDS: 20, SHAKE_INTENSITY: 2.0
        };

        let scene, camera, renderer, ship, engineBeam, engineLight, audioCtx;
		const clock = new THREE.Clock();
        let scopeCamera, scopeRenderer, starFields = [], localStars, targets = [], bullets = [], explosions = [];
        let phoneZero = { beta: 0, gamma: 0 }, currentRotationVel = { p: 0, y: 0 };
        let isInitialized = false, isThrusting = false, gameActive = false, pendingShot = false;
        let velocityVec = new THREE.Vector3(), gunTipVelocity = new THREE.Vector3(), prevGunTipPos = new THREE.Vector3();
        let score = 0, wave = 1, targetsInWave = 12, timeLeft = CONFIG.MISSION_TIME, currentBestShot = 0;

        function playExplosionSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(20, t + 0.7);
            gain.gain.setValueAtTime(1.5, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.8);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(t); osc.stop(t + 0.8);
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(CONFIG.BASE_FOV, window.innerWidth / window.innerHeight, 1, 30000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const sun = new THREE.DirectionalLight(0xffffff, 1.5); sun.position.set(10, 20, 10); scene.add(sun);
            
            // Scope setup
            scopeCamera = new THREE.PerspectiveCamera(CONFIG.SCOPE_FOV, 1, 1, 3000);
            scopeRenderer = new THREE.WebGLRenderer({ canvas: document.getElementById('scopeCanvas'), antialias: true });
            scopeRenderer.setSize(220, 220); scopeRenderer.setClearColor(0x000000, 1.0);

            // Crosshair drawing
            const ctx = document.getElementById('scopeCrosshair').getContext('2d');
            ctx.strokeStyle = 'red'; ctx.lineWidth = 1.2;
            [0, 90, 180, 270].forEach(a => {
                ctx.save(); ctx.translate(110, 110); ctx.rotate(a * Math.PI / 180);
                ctx.beginPath(); ctx.moveTo(0, 8); ctx.lineTo(0, 63); ctx.stroke(); ctx.restore();
            });

            spawnWave(); animate();
        }

        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            if (ship && isInitialized) {
                const camQuat = camera.quaternion.clone();
                ship.rotateOnWorldAxis(new THREE.Vector3(0,1,0).applyQuaternion(camQuat), -currentRotationVel.y);
                ship.rotateOnWorldAxis(new THREE.Vector3(1,0,0).applyQuaternion(camQuat), -currentRotationVel.p);
                
                const currentGunTip = new THREE.Vector3(0,0,15).applyQuaternion(ship.quaternion).add(ship.position);
                if (dt > 0) gunTipVelocity.subVectors(currentGunTip, prevGunTipPos);
                prevGunTipPos.copy(currentGunTip);

                if (pendingShot) {
                    const b = new THREE.Group();
                    b.add(new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshBasicMaterial({color:0xff00ff})));
                    b.position.copy(currentGunTip);
                    b.userData = { vel: new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion).multiplyScalar(CONFIG.BULLET_SPEED).add(gunTipVelocity), spawn: Date.now(), origin: currentGunTip.clone() };
                    scene.add(b); bullets.push(b); pendingShot = false;
                }

                if (isThrusting) {
                    velocityVec.add(new THREE.Vector3(0,0,1).applyQuaternion(ship.quaternion).multiplyScalar(CONFIG.ACCEL_FORCE));
                    if (velocityVec.length() > CONFIG.MAX_VELOCITY) velocityVec.setLength(CONFIG.MAX_VELOCITY);
                } else { velocityVec.multiplyScalar(CONFIG.DRIFT_INERTIA); }
                ship.position.add(velocityVec);
                camera.position.lerp(ship.position.clone().add(new THREE.Vector3(0,10,40).applyQuaternion(ship.quaternion)), 0.1);
                camera.lookAt(ship.position);
            }

            targets.forEach(t => {
                t.userData.angle += t.userData.speed;
                t.position.copy(t.userData.center).add(new THREE.Vector3(Math.cos(t.userData.angle)*t.userData.radius, 0, Math.sin(t.userData.angle)*t.userData.radius).applyQuaternion(new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0,1,0), t.userData.axis)));
            });

            bullets.forEach((b, i) => {
                b.position.add(b.userData.vel);
                targets.forEach((t, j) => {
                    if (b.position.distanceTo(t.position) < 30) {
                        const pts = 10 + Math.floor(b.position.distanceTo(b.userData.origin)/10);
                        score += pts; if(pts > currentBestShot) currentBestShot = pts;
                        playExplosionSound(); scene.remove(t); targets.splice(j,1); scene.remove(b); bullets.splice(i,1);
                        if(targets.length === 0) spawnWave();
                    }
                });
            });
            renderer.render(scene, camera);
        }

        function spawnWave() {
            for(let i=0; i<targetsInWave; i++) {
                const t = new THREE.Mesh(new THREE.IcosahedronGeometry(15), new THREE.MeshStandardMaterial({color:0x00ff00}));
                t.userData = { center: new THREE.Vector3((Math.random()-0.5)*2000, (Math.random()-0.5)*1000, -1000), radius: 300+Math.random()*1100, speed: 0.001, angle: Math.random()*Math.PI*2, axis: new THREE.Vector3(Math.random(),1,Math.random()).normalize() };
                scene.add(t); targets.push(t);
            }
        }

        function startTimer() {
            const int = setInterval(() => {
                if(timeLeft > 0 && gameActive) { timeLeft--; document.getElementById('timer').innerText = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`; }
                else { clearInterval(int); gameActive = false; document.getElementById('results').style.display = 'block'; }
            }, 1000);
        }

        document.getElementById('startBtn').addEventListener('click', () => {
            audioCtx = new AudioContext(); gameActive = true; document.getElementById('ui').style.display='none'; document.getElementById('hud').style.display='block'; init(); startTimer();
        });
    </script>
</body>
</html>